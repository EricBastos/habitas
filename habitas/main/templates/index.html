{% extends '_base.html' %} {% load unicorn %}{% load static %} {% block header %}

<link rel="stylesheet" href="{% static 'index.css' %}" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
  integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
  integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
  crossorigin=""
></script>
<script type="text/javascript" src="{% static 'js/city.js' %}"></script>
<script type="text/javascript" src="{% static 'js/bairros.js' %}"></script>

<script src='https://unpkg.com/@turf/turf@6/turf.min.js'
crossorigin=""></script>


{% endblock %} {% block title %} Habitas {% endblock %} {% block content %}

<div class="grid grid-cols-4 my-4 scrollbar-thin scrollbar scrollbar-thumb-gray-300" style="overflow-y: auto;max-height: 100vh;">
  <div
    class="col-span-1 mx-2 px-6 items-center scrollbar-thin scrollbar scrollbar-thumb-gray-300 scrollbar-track-gray-100 bg-clip-content border h-[calc(93vh-90px)]"
    style="overflow-y: auto;max-height: 100vh;">
    <h1 class="text-3xl text-left font-bold my-2 w-fit">
      Árvores de SJC
      <hr class="bg-emerald-600 h-2.5 w-full my-2" />
    </h1>
    <p class="text-left text-xl font-medium my-2">
      Aprenda sobre as árvores de sua vizinhança.
    </p>
    <p class="text-left font-light">
      Pela primeira vez, você tem acesso a informações sobre as árvores 
      do Campus do CTA. Aprenda sobre as árvores que compõem a floresta urbana da nossa cidade.
    </p>
    <h1 class="text-2xl text-left font-medium my-4 w-fit">
      Estatísticas gerais
      <hr class="bg-emerald-900 h-1.5 w-full" />
    </h1>

      <div class="grid grid-cols-3" id="estatisticas-gerais">
{#      {% for stat_name, stat in stats.items %}#}
{#        <div class="my-2">#}
{#          <span class="font-bold text-xl">{{stat}}</span>#}
{#          <br>#}
{#          <span class="text-lg">{{stat_name | safe}}</span> #}
{#        </div>#}
{#      {% endfor %}#}
    </div>

{#    <div class="grid grid-cols-3">#}
{#      {% for stat_name, stat in stats.items %}#}
{#        <div class="my-2">#}
{#          <span class="font-bold text-xl">{{stat}}</span>#}
{#          <br>#}
{#          <span class="text-lg">{{stat_name | safe}}</span> #}
{#        </div>#}
{#      {% endfor %}#}
{#    </div>#}

    <h1 class="text-2xl text-left font-medium my-4 w-fit">
      Benefícios ecológicos
      <hr class="bg-emerald-900 h-1.5 w-full" />
    </h1>

    {% for stat_name, stat in eco_stats.items %}
      <div class="my-2">
        <div class="font-bold text-xl">{{stat_name | safe}}</div>
        <div style="display: grid; grid-auto-flow: column;">
          <span class="text-lg">{{stat.value}} <span style="color: rgb(5 150 105)">{{stat.value_text}}</span></span>
            <span class="text-lg"><span style="color: rgb(5 150 105)">Valor: </span>{{stat.money}} R$</span>
        </div>
      </div>
    {% endfor %}


    <div id="estatisticas" style="visibility:hidden;">

    <h1 class="text-2xl text-left font-medium my-4 w-fit">
      Informações sobre a árvore
      <hr class="bg-emerald-900 h-1.5 w-full" />
    </h1>
    <h1 class="text-2xl text-left font-medium my-4 w-fit" id="nome_popular">
      <hr class="bg-emerald-900 h-1.5 w-full"/>
    </h1>
    <p class="text-left " id="dados">
    </p>
      <h2 class="text-2xl text-left font-medium my-4 w-fit">
        Comentários
        <hr class="bg-emerald-900 h-1.5 w-full" />
      </h2>
      {% unicorn 'posts' %}
    </div>
  </div>
  <div class="z-0 col-span-3 pr-2 h-screen">
    <div id="map" class="z-0 min-w-max"></div>
    <div class="flex w-full h-max flex-row-reverse items-center my-4">
      <span class="text-emerald-600 font-serif flex flex-row">
        <svg
          class="h-6 w-6 text-emerald-600"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            stroke="none"
            d="M0
                            0h24v24H0z"
          />
          <rect x="4" y="3" width="8" height="14" rx="4" />
          <rect x="12" y="7" width="8" height="10" rx="3" />
          <line x1="8" y1="21" x2="8" y2="13" />
          <line x1="16" y1="21" x2="16" y2="14" />
        </svg>
        <span class="text-xl">Habitas</span><sup class="text-sm">®</sup>
        <span class="underline"></span>
      </span>
    </div>
  </div>
</div>

<script>

function create_google_maps_url(lat, long){
  return `http://maps.google.com/maps?z=12&t=m&q=loc:${lat}+${long}`
}

</script>

<script>
  // load trees from context to list

  var map = L.map("map").setView([-23.205459913570404, -45.88184219354045], 15);

  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  }).addTo(map);

function filterPointsInPolygon(polygon, circles) {
    // Check if both polygon and points are defined

    try {
        // Check if Turf.js is available and has the necessary functions
        if (typeof turf !== 'undefined' && turf.booleanPointInPolygon) {
            // Log the inputs for debugging

            // Filter points within the clicked neighborhood
            return circles.filter(circle => {
                // Log the point for debugging
                //console.log("Point:", point);

                point = circle.toGeoJSON()

                try {
                    // Check if the point has valid geometry and properties
                    const coordinates = point.geometry && point.geometry.coordinates;
                    //console.log("ok", coordinates, polygon.geometry.coordinates)

                    if (coordinates && Array.isArray(coordinates) && coordinates.length === 2) {

                        // Check if the coordinates are valid before invoking Turf.js
                        return turf.booleanPointInPolygon(turf.point(coordinates), turf.polygon(polygon.geometry.coordinates));
                    } else {
                        console.error("Invalid point:", point);
                        return false;
                    }
                } catch (error) {
                    console.error("Error in filtering points:", error);
                    return false;
                }
            });
        } else {
            console.error("Turf.js or its functions are not available.");
            return [];
        }
    } catch (error) {
        console.error("Error in filtering points:", error);
        return [];
    }
}

  L.geoJSON(CITY_LIMIT).addTo(map);
// Assume BAIRROS is a GeoJSON layer representing neighborhoods
const neighborhoodsLayer = L.geoJSON(BAIRROS).addTo(map);

let filteredPointsLayer = null;

// Define a function to handle the click event on neighborhoods
function highlightNeighborhood(e) {
    const clickedLayer = e.target;

    // Reset the style of all neighborhood polygons
    neighborhoodsLayer.setStyle({
        weight: 3,
        color: '#3388ff',
        dashArray: '',
        fillOpacity: 0.2
    });

    // Highlight the clicked neighborhood
    clickedLayer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.4
    });

    circleLayerGroup.clearLayers();

    // Filter points within the clicked neighborhood
    const clickedNeighborhood = clickedLayer.toGeoJSON();
    const filteredCircles = filterPointsInPolygon(clickedNeighborhood, originalCircles);

    // Create new circle markers for the filtered points and add them to the layer group
    filteredCircles.forEach(circle => {
        circleLayerGroup.addLayer(circle)
    });

      const tmp = filteredCircles.map(a => a.tree_species)
  console.log(tmp)

  const tmp2 = filteredCircles.map(a => a.n_posts)
  console.log(tmp2)

  const species = new Set(tmp).size;
  const total_n_posts = tmp2.reduce((a,b)=>a+b, 0)

      document.getElementById("estatisticas-gerais").innerHTML = `
        <div class="my-2">
          <span class="font-bold text-xl">${filteredCircles.length}</span>
          <br>
          <span class="text-lg">Árvores Cadastradas</span>
        </div>
        <div class="my-2">
          <span class="font-bold text-xl">${species}</span>
          <br>
          <span class="text-lg">Espécies</span>
        </div>
        <div class="my-2">
          <span class="font-bold text-xl">${total_n_posts}</span>
          <br>
          <span class="text-lg">Comentários</span>
        </div>
        `

    // You can also do something with the neighborhood's properties or perform other actions here

}

// Add the click event listener to each neighborhood polygon
neighborhoodsLayer.eachLayer(layer => {
    layer.on('click', highlightNeighborhood);
});

  function onMapClick(index) {
    tree = tree_map.get(index)
    Unicorn.call("posts", "update", tree.id);
    let img_links = ''
      for (let i = 1; i < tree.imagens.length; i++) {
           img_links = img_links + `<img src="https://arvores.sjc.sp.gov.br${tree.imagens[i]}">`
      }
    let laudos = ''
      for (let i = 1; i < tree.laudos.length; i++) {
           laudos = laudos + `<a href="https://arvores.sjc.sp.gov.br${tree.laudos[i]}" class="underline text-blue-500">laudo ${i}</a>`
      }
    google_maps_url = create_google_maps_url(tree.latitude, tree.longitude)

    document.getElementById("estatisticas").style.visibility = "visible";
    document.getElementById("dados").innerHTML = `
      <p>Id. da árvore: ${tree.numero}</p>
      <p>Nome científico: ${tree.nome_cientifico}</p>
      <p>Diâmetro: ${tree.dap} cm</p>
      <p>Altura: ${tree.altura} m</p>
      <p>Google maps: <a href="${google_maps_url}" class="underline text-blue-500">link</a></p>
      <p>CO<sub>2</sub> retido: ${ Math.round(1000 * tree.co2) } kg</p>
      <p>Água de chuva interceptada: ${ Math.round(tree.stormwater) } L</p>
      <p>Plantado por: ${tree.plantado_por } </p>
      <p>Laudos: ${laudos} </p>
      <p>Imagens: ${img_links}</p>
    `

    document.getElementById("nome_popular").innerHTML = `${tree.nome_popular}`;

    // use tree_dict.id to load posts using django_unicorn




  }

  tree_map = new Map();

  {% for tree in trees %}
    tree_obj = {
        id: {{ tree.id }},
        nome_popular: "{{ tree.nome_popular }}",
        nome_cientifico: "{{ tree.nome_cientifico }}",
        dap: "{{ tree.dap }}",
        altura: "{{ tree.altura }}",
        data_da_coleta: "{{ tree.data_da_coleta }}",
        latitude: "{{ tree.latitude }}",
        longitude: "{{ tree.longitude }}",
        numero: {{ tree.N_placa }},
        n_comentarios: {{ tree.n_posts }},
        co2: {{ tree.stored_co2 }},
        stormwater: {{ tree.stormwater_intercepted }},
        color: "green",
        plantado_por: "{{ tree.plantado_por }}",
        imagens: "{{ tree.imagem }}".split(',').map(function(path) {
                                      return path.trim();
                                    }),
        laudos: "{{ tree.laudo }}".split(',').map(function(path) {
                                      return path.trim();
                                    }),
    };

    if (tree_obj.n_comentarios > 0)
      tree_obj.color = "yellow";

    tree_map.set(tree_obj.id, tree_obj)
  {% endfor %}


  // circle_map = new Map();
  lastClickedCircle = undefined;

  const circleLayerGroup = L.layerGroup();

  const originalCircles = []

  for (let [tree_id, tree] of tree_map) {
    circle = L.circle(
        [tree.latitude, tree.longitude],
        {
          color: tree.color,
          fillColor: tree.color,
          fillOpacity: 0.5,
          radius: 5,
          selected: false,
        }
    )
    circle.tree_id = tree_id;
    circle.tree_species=tree.nome_cientifico
    circle.n_posts = tree.n_comentarios

    circle.on("click", function(){
      if (lastClickedCircle){
        lastClickedCircle.setStyle({
          color: tree_map.get(lastClickedCircle.tree_id).color,
          fillColor: tree_map.get(lastClickedCircle.tree_id).color
        });
      }

      onMapClick(tree_id);
      lastClickedCircle = this;
      this.setStyle({color: 'red', fillColor: '#f00'});
    })

    originalCircles.push(circle)

  }

  originalCircles.forEach(circle => circleLayerGroup.addLayer(circle));
  circleLayerGroup.addTo(map);

  const tmp = originalCircles.map(a => a.tree_species)
  console.log(tmp)

  const tmp2 = originalCircles.map(a => a.n_posts)
  console.log(tmp2)

  const species = new Set(tmp).size;
  const total_n_posts = tmp2.reduce((a,b)=>a+b, 0)

      document.getElementById("estatisticas-gerais").innerHTML = `
        <div class="my-2">
          <span class="font-bold text-xl">${originalCircles.length}</span>
          <br>
          <span class="text-lg">Árvores Cadastradas</span>
        </div>
        <div class="my-2">
          <span class="font-bold text-xl">${species}</span>
          <br>
          <span class="text-lg">Espécies</span>
        </div>
        <div class="my-2">
          <span class="font-bold text-xl">${total_n_posts}</span>
          <br>
          <span class="text-lg">Comentários</span>
        </div>
        `


  // circlearray.forEach(function (circle, index) {
  //     tree_dict = tree_array[index]
  //     popup = `<span class="font-bold text-ellipsis">Nome popular:</span> ${tree_dict.nome_popular}<br>` +
  //         `<span class="font-bold text-ellipsis">Nome científico:</span> ${tree_dict.nome_cientifico}<br>` +
  //         `<span class="font-bold text-ellipsis">Diâmetro:</span> ${tree_dict.dap}cm<br>`
  //     "DAP: " + tree_dict.dap + "<br>" + "Altura: " + tree_dict.altura + "<br>" + "Data da coleta: " + tree_dict.data_da_coleta + "<br>" + "Latitude: " + tree_dict.latitude + "<br>" + "Longitude: " + tree_dict.longitude;
  //     circle.bindPopup(popup)
  // });
  // circlearray.forEach(function (circle, index) {
  //   circle.on("click", function () {
  //     lastClickedCircle.setStyle({color: 'green', fillColor: '#040'});
  //     onMapClick(index);
  //     this.setStyle({color: 'red', fillColor: '#f00'});
  //     lastClickedCircle = this;
  //   });
  // });
</script>

{% endblock %}
